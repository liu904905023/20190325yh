<include file="Base:header"/>

<div class="main-content">

    <div class="breadcrumbs" id="breadcrumbs">

        <script type="text/javascript">try {

            ace.settings.check('breadcrumbs', 'fixed')

        } catch (e) {

        }</script>

        <ul class="breadcrumb">

            <li>

                <i class="icon-home home-icon"></i>

                <a href="__APP__">首页</a>

            </li>

            <li>库存列表</li>

        </ul>

    </div>


    <div class="page-content">

        <div class="page-header">

            <h1>库存列表</h1>

        </div>

        <div class="row">

            <!-- <form class="form-horizontal" id="validation-form" method="post" action="__SELF__"> -->

            <div class="col-xs-12 sx-search">

                <div class="col-md-6 col-xs-12 mr_mab">

                    <div class="form-group">

                        <label for="productNumber" class="control-label col-sm-3">产品编号</label>

                        <div class="col-sm-8">
                            <input type="text" id="productNumber" name="productNumber" class="form-control"
                                   placeholder="产品编号"></div>
                    </div>

                </div>
                <div class="col-md-6 col-xs-12 mr_mab">

                    <div class="form-group">

                        <label>&nbsp;</label>

                        <button class="btn btn-primary" id="search">
                            <i class="icon-search"></i>
                            查询
                        </button>
                        <label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                        <button class="btn btn-success" id="addStock">
                            <i class="icon-edit"></i>
                            入库
                        </button>

                    </div>
                </div>
                <div class="clearfix"></div>

                <div class="row">

                    <div class="table-header">查询结果</div>

                    <div class="col-xs-12">

                        <div class="table-responsive">

                            <table id="sample-table-1" class="table table-striped table-bordered table-hover">

                                <thead>

                                <tr>

                                    <th>编号</th>

                                    <th>产品编号</th>

                                    <th>进货金额</th>

                                    <th>进货数量</th>

                                    <th>出货金额</th>

                                    <th>库存数量</th>

                                    <th>进货时间</th>

                                    <th>销售时间</th>

                                    <th>操作</th>


                                </tr>

                                </thead>

                                <tbody id="info">


                                </tbody>


                            </table>


                        </div>

                    </div>

                </div>

            </div>

            <!-- </form> -->

        </div>

    </div>

</div>

</div>

</div>
<div class="modal fade" id="updateStock" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="myModalLabel">补库</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" id="validation-form" method="post">
                    <div class="row">

                        <div class="col-lg-12 col-md-12 col-xs-12 col-sm-12">

                            <div class="form-group">

                                <div class="col-xs-12 mr_mab"><label>产品编号</label>

                                    <div class="over"><input type="text"
                                                             class="form-control"
                                                             name="productNumber"
                                                             id="productNo"
                                                             placeholder="产品编号" value=""
                                                             disabled/>
                                    </div>

                                </div>

                            </div>

                        </div>
                        <div class="clearfix"></div>
                        <div class="col-lg-12 col-md-12 col-xs-12 col-sm-12">

                            <div class="form-group">

                                <div class="col-xs-12 mr_mab"><label>进货金额</label>

                                    <div class="over"><input type="text"
                                                             class="form-control"
                                                             name="stockMoney"
                                                             id="stockMoney"
                                                             placeholder="进货金额" value=""
                                                             disabled/>
                                    </div>

                                </div>

                            </div>

                        </div>

                        <div class="clearfix"></div>
                        <div class="col-lg-12 col-md-12 col-xs-12 col-sm-12">

                            <div class="form-group">

                                <div class="col-xs-12 mr_mab"><label>出货金额</label>

                                    <div class="over"><input type="text"
                                                             class="form-control"
                                                             name="shipmentMoney"
                                                             id="shipmentMoney"
                                                             placeholder="出货金额" value=""
                                                             disabled/>
                                    </div>

                                </div>

                            </div>

                        </div>
                        <div class="clearfix"></div>
                        <div class="col-lg-12 col-md-12 col-xs-12 col-sm-12">

                            <div class="form-group">

                                <div class="col-xs-12 mr_mab"><label>现金券面值</label>

                                    <div class="over"><input class="form-control" type="text"
                                                             id="upMoney" name="upMoney" value=""
                                                             disabled>
                                    </div>

                                </div>

                            </div>

                        </div>

                        <div class="clearfix"></div>
                        <div class="col-lg-12 col-md-12 col-xs-12 col-sm-12">

                            <div class="form-group">

                                <div class="col-xs-12 mr_mab"><label>补货数量</label>

                                    <div class="over"><input type="text"
                                                             class="form-control"
                                                             name="stockCount"
                                                             id="stockCount"
                                                             placeholder="补货数量" value=""/>
                                    </div>

                                </div>

                            </div>

                        </div>

                    </div>
            </div>
            <div class="clearfix"></div>
            <input type="hidden" id='SysNo' value="">
            <div class="modal-footer">
                <div class="row">
                    <div class="form-group">

                        <div class="col-xs-12">

                            <button type="submit" class="btn btn-primary"><i
                                    class="icon-ok bigger-110"></i> 保存修改
                            </button>

                        </div>
                    </div>
                </div>
            </div>
            </form>
        </div>
    </div>
</div>
<div class="modal fade" id="addStockModal" tabindex="-1" role="dialog" aria-labelledby="addStockModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="addStockModalLabel">入库</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" id="addValidation-form" method="post">

                    <div class="row">

                        <div class="col-lg-12 col-md-12 col-xs-12 col-sm-12">

                            <div class="form-group">

                                <div class="col-xs-12 mr_mab"><label>产品编号</label>

                                    <div class="over"><input type="text"
                                                             class="form-control"
                                                             name="productNumber"
                                                             id="addProductNumber"
                                                             placeholder="产品编号" value=""
                                    />
                                    </div>

                                </div>

                            </div>

                        </div>
                        <div class="clearfix"></div>
                        <div class="col-lg-12 col-md-12 col-xs-12 col-sm-12">

                            <div class="form-group">

                                <div class="col-xs-12 mr_mab"><label>进货金额</label>

                                    <div class="over"><input type="text"
                                                             class="form-control"
                                                             name="stockMoney"
                                                             id="addStockMoney"
                                                             placeholder="进货金额" value=""
                                    />
                                    </div>

                                </div>

                            </div>

                        </div>
                        <div class="clearfix"></div>
                        <div class="col-lg-12 col-md-12 col-xs-12 col-sm-12">

                            <div class="form-group">

                                <div class="col-xs-12 mr_mab"><label>进货数量</label>

                                    <div class="over"><input type="text"
                                                             class="form-control"
                                                             name="stockCount"
                                                             id="addStockCount"
                                                             placeholder="进货数量" value=""/>
                                    </div>

                                </div>

                            </div>

                        </div>
                        <div class="clearfix"></div>
                        <div class="col-lg-12 col-md-12 col-xs-12 col-sm-12">

                            <div class="form-group">

                                <div class="col-xs-12 mr_mab"><label>出货金额</label>

                                    <div class="over"><input type="text"
                                                             class="form-control"
                                                             name="shipmentMoney"
                                                             id="addShipmentMoney"
                                                             placeholder="出货金额" value=""
                                    />
                                    </div>

                                </div>

                            </div>

                        </div>
                        <div class="clearfix"></div>
                        <div class="col-lg-12 col-md-12 col-xs-12 col-sm-12">

                            <div class="form-group">

                                <div class="col-xs-12 mr_mab"><label>现金券面值</label>

                                    <div class="over"><select class="form-control"
                                                              id="addMoney" name="money"
                                    >

                                        <option value="">请选择金额</option>
                                        <php>foreach($data as $key=>$row){</php>
                                        <option value="<php>echo $row['SysNo'];</php>">
                                            <php>echo ($row['Money']);</php>
                                            元
                                        </option>

                                        <php>}</php>


                                    </select></div>

                                </div>

                            </div>

                        </div>

                        <div class="clearfix"></div>

                    </div>


            </div>
            <div class="modal-footer">
                <div class="row">
                    <div class="form-group">

                        <div class="col-xs-12">

                            <button type="submit" class="btn btn-primary"><i
                                    class="icon-ok bigger-110"></i> 确定
                            </button>

                        </div>

                    </div>
                </div>
            </div>
            </form>
        </div>
    </div>
</div>
<include file="Base:jsfile"/>

<script>
    $('#addStock').on('click', function () {
        $('#addStockModal').modal('show');
    })
    var PageSize = $("#PageSize").val();
    infoview(0, PageSize);
    $("#search").click(function () {
        infoview(0, PageSize);
    });

    function infoview(PageNumber, PageSize) {
        var productNumber = $("#productNumber").val();
        var tt = "";
        if (this.ajaxRequest_ != undefined && this.ajaxRequest_.readyState < 4) {
            return false;
        }
        this.ajaxRequest_ =
            $.post(
                "__SELF__", {
                    productNumber: productNumber
                }, function (data) {
                    if (data) {
                        $.each(data.model, function (k, v) {
                            tt += "<tr><td>" + v.SysNo + "</td><td>" + v.Product_no + "</td><td>" + v.Purchase_Amount + "</td><td>" + v.Purchase_Num + "</td><td>" + v.Selling_Amount + "</td><td>" + v.Selling_Num + "</td><td>" + v.Purchase_Time + "</td><td>" + v.Selling_Time + "</td><td><input type='hidden' value=" + v.SysNo + "><input type='hidden' value=" + v.Money_TypeSysNo + "><button type=\"button\" class=\"btn btn-danger btn-xs updateSt\">\n" + "补库\n" + "</button></td></tr>";
                        });
                        $("#info").html(tt);
                        $('#TotalCount').html(data.totalCount);
                        TotalPage = Math.ceil(data.totalCount / PageSize);
                        var ff = "";
                        for (i = 1; i <= TotalPage; i++) {
                            ff += "<option value = \"" + i + "\">" + i + "</option>";
                        }
                        $('#SelectNo').html(ff);
                        $('#TotalPage').html(TotalPage);
                        $('#PageNumber').html(PageNumber);
                        $('#SelectNo').val(PageNumber + 1);
                        $('#NowPage').text(PageNumber + 1);
                        $(".page_new").show();
                    } else {
                        $('#info').html("");
                        $(".page_new").hide();
                    }
                });
    }

    $(".updateSt").live('click', function () {
        $('#updateStock').modal('show');
        var temp = $(this).parent().siblings();
        var SysNo = $(this).siblings().eq(0).val();
        $("#SysNo").val(SysNo);
        $("#productNo").val(temp.eq(1).text());
        $("#stockMoney").val(temp.eq(2).text());
        $("#shipmentMoney").val(temp.eq(4).text());
        $.ajax({
            type: "post",
            url: "__APP__/EFuliStock/queryStockAmount",
            data: {
                SysNo: $(this).siblings().eq(1).val()
            },
            async: false,
            success: function (data) {
                $('#upMoney').val(data[0]['Money']);
            },
            error: function () {
                show_alert('ajax error!');
            }
        })

    });

    // 弹窗隐藏，清空值及状态 （修改弹窗）
    $('#updateStock').on('hidden.bs.modal', function (e) {
        $('#stockCount').val('');
        $(this).find('.form-group').removeClass('has-info has-error');
        $(this).find('.help-block').css('display', 'none');
    })

    // 弹窗隐藏，清空值及状态 （新增弹窗）
    $('#addStockModal').on('hidden.bs.modal', function (e) {
        $(this).find('input,select').val('');
        $(this).find('.form-group').removeClass('has-info has-error');
        $(this).find('.help-block').css('display', 'none');
    })

    $("#send").live('click', function () {

        $.ajax({
            type: "post",
            url: "__APP__/EFuliStock/updateStock",
            data: {
                SysNo: $("#SysNo").val(),
                stockCount: $('#stockCount').val()
            },
            async: false,
            success: function (data) {
                if (data.Code == 0) {
                    $('#updateStock').modal('hide');
                    $('#stockCount').val('');
                    show_alert("库存修改成功!");
                    infoview(0, PageSize);
                } else {
                    show_alert(data.Description);
                }
            },
            error: function () {
                show_alert('ajax error!');
            }
        })

    })
</script>

<script>
    $.validator.addMethod("money", function (value, element) {
        let reg = /^(([1-9][0-9]*)|(([0]\.\d{1,2}|[1-9][0-9]*\.\d{1,2})))$/
        if (reg.exec(value)) {
            return true;
        } else {
            return false;
        }
    });
    $.validator.addMethod("zero", function (value, element) {
        let reg = /^(?:(?!(0\.0|0\.00)$))[\d\D]*/
        if (reg.exec(value)) {
            return true;
        } else {
            return false;
        }
    });
    $('#addValidation-form').validate({

        errorElement: 'div',

        errorClass: 'help-block',

        focusInvalid: false,

        rules: {

            productNumber: {required: true, rangelength: [0, 50], username: true},

            stockMoney: {required: true, money: true, zero: true, max: 9999.99},

            stockCount: {required: true, min: 1, max: 9999, digits: true},

            shipmentMoney: {required: true, money: true, zero: true, max: 9999.99},

            money: {required: true}
        },

        messages: {

            productNumber: {required: '请输入产品编号.', rangelength: '请输入正确位数的产品编号.', username: '请输入正确格式的产品编号.'},

            stockMoney: {required: '请输入进货金额.', money: '请输入正确格式的金额.', zero: '请输入正确格式的金额.', max: '请输入正确的金额.'},

            stockCount: {required: '请输入进货数量.', min: '进货数量不能小于1.', digits: '请输入整数.', max: '进货数量不能大于9999'},

            shipmentMoney: {required: '请输入出货金额.', money: '请输入正确格式的金额.', zero: '请输入正确格式的金额.', max: '请输入正确的金额.'},

            money: {required: '请选择现金券面值.'},

            subscription: "Please choose at least one option",

            gender: "Please choose gender",

            agree: "Please accept our policy"

        },

        invalidHandler: function (event, validator) {

            $('.alert-danger', $('.login-form')).show();

        },

        highlight: function (e) {

            $(e).closest('.form-group').removeClass('has-info').addClass('has-error');

        },

        success: function (e) {

            $(e).closest('.form-group').removeClass('has-error').addClass('has-info');

            $(e).remove();

        },

        errorPlacement: function (error, element) {

            if (element.is(':checkbox') || element.is(':radio')) {

                var controls = element.closest('div[class*="col-"]');

                if (controls.find(':checkbox,:radio').length > 1) controls.append(error); else error.insertAfter(element.nextAll('.lbl:eq(0)').eq(0));

            } else if (element.is('.select2')) {

                error.insertAfter(element.siblings('[class*="select2-container"]:eq(0)'));

            } else if (element.is('.chosen-select')) {

                error.insertAfter(element.siblings('[class*="chosen-container"]:eq(0)'));

            } else error.insertAfter(element.parent());

        },

        submitHandler: function (form) {

            $.ajax({

                type: "POST",

                url: "__APP__/EFuliStock/addStock",

                data: {
                    productNumber: $('#addProductNumber').val(),
                    stockMoney: $('#addStockMoney').val(),
                    stockCount: $('#addStockCount').val(),
                    shipmentMoney: $('#addShipmentMoney').val(),
                    money: $('#addMoney').val()
                },

                async: false,

                success: function (data) {
                    if (data.Code == 0) {
                        document.getElementById('addValidation-form').reset();
                        $('#addStockModal').modal('hide');
                        show_alert("库存新增成功!");
                    } else {
                        show_alert(data.Description);
                    }

                }

            });

        },

        invalidHandler: function (form) {

            console.log("ajax失败！");

        }

    });

</script>

<script type="text/javascript">
    jQuery(function ($) {

        $('#validation-form').validate({

            errorElement: 'div',

            errorClass: 'help-block',

            focusInvalid: false,

            rules: {

                stockCount: {required: true, min: 1, max: 9999, digits: true},
            },

            messages: {

                stockCount: {required: '请输入进货数量.', min: '进货数量不能小于1.', max: '进货数量不能大于9999', digits: '请输入整数.'},

                subscription: "Please choose at least one option",

                gender: "Please choose gender",

                agree: "Please accept our policy"

            },

            invalidHandler: function (event, validator) {

                $('.alert-danger', $('.login-form')).show();

            },

            highlight: function (e) {

                $(e).closest('.form-group').removeClass('has-info').addClass('has-error');

            },

            success: function (e) {

                $(e).closest('.form-group').removeClass('has-error').addClass('has-info');

                $(e).remove();

            },

            errorPlacement: function (error, element) {

                if (element.is(':checkbox') || element.is(':radio')) {

                    var controls = element.closest('div[class*="col-"]');

                    if (controls.find(':checkbox,:radio').length > 1) controls.append(error); else error.insertAfter(element.nextAll('.lbl:eq(0)').eq(0));

                } else if (element.is('.select2')) {

                    error.insertAfter(element.siblings('[class*="select2-container"]:eq(0)'));

                } else if (element.is('.chosen-select')) {

                    error.insertAfter(element.siblings('[class*="chosen-container"]:eq(0)'));

                } else error.insertAfter(element.parent());

            },

            submitHandler: function (form) {

                $.ajax({

                    type: "POST",

                    url: "__APP__/EFuliStock/updateStock",

                    data: {
                        SysNo: $("#SysNo").val(),
                        stockCount: $('#stockCount').val()
                    },

                    async: false,

                    success: function (data) {
                        if (data.Code == 0) {
                            $('#updateStock').modal('hide');
                            document.getElementById('validation-form').reset();
                            show_alert("库存修改成功!");
                            infoview(0, PageSize);
                        } else {
                            show_alert(data.Description);
                        }

                    }

                })

            },

            invalidHandler: function (form) {

                console.log("ajax失败！");

            }

        });

    })</script>
<include file="Base:footer"/>